#!/usr/bin/env bash

MIN_BITRATE=${1:-320}
LOGFILE="./lowbitrate.log"

echo "ðŸ” Scanning for MP3s below ${MIN_BITRATE} kbps..."
echo "---- Scan started: $(date) ----" > "$LOGFILE"

find . -maxdepth 3 -iname '*.[Mm][Pp]3' -exec sh -c '
  FILE="$1"
  MIN="$2"

  BITRATE=$(mp3info -r a -p "%r\n" "$FILE" 2>/dev/null)

  if [ -z "$BITRATE" ]; then
    echo "UNREADABLE | $FILE | bitrate not found"
    exit 0
  fi

  # convert float to integer (e.g. 320.000000 -> 320)
  BITRATE_INT=${BITRATE%.*}

  if [ "$BITRATE_INT" -lt "$MIN" ]; then
    echo "LOW        | $FILE | ${BITRATE_INT} kbps"
  fi
' sh {} "$MIN_BITRATE" \; | tee -a "$LOGFILE"

echo "---- Scan finished: $(date) ----" >> "$LOGFILE"