#!/usr/bin/env bash

# Convert all *.ape files in the current folder to FLAC and delete originals only if conversion is successful
# Requires: ffmpeg

set -euo pipefail
shopt -s nullglob  # avoid errors if no APE files

for ape in *.ape; do
    flac="${ape%.ape}.flac"
    echo "ğŸ”„ Converting '$ape' â†’ '$flac' ..."

    if ! ffmpeg -v error -i "$ape" "$flac" -y; then
        echo "âš ï¸ Conversion failed â€” skipping '$ape'"
        continue
    fi

    if ! ffmpeg -v error -f flac -i "$flac" -f null - 2>/dev/null; then
        echo "âš ï¸ Integrity check failed â€” skipping deletion of '$ape'"
        continue
    fi

    # delete original ape if everything succeeded
    rm "$ape"
    echo "âœ… Conversion OK â€” deleted original: $ape"
done

echo "ğŸ‰ All conversions completed."
